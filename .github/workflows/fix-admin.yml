name: Fix Admin Setup

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Generate BCrypt hash and update admin
        shell: powershell
        run: |
          # Create a tiny console app to generate the BCrypt hash
          $tmpDir = "_hashgen"
          if (Test-Path $tmpDir) { Remove-Item $tmpDir -Recurse -Force }
          dotnet new console -o $tmpDir --no-restore --force | Out-Null
          dotnet add $tmpDir package BCrypt.Net-Next | Out-Null
          
          Set-Content "$tmpDir\Program.cs" 'Console.Write(BCrypt.Net.BCrypt.HashPassword("SopBuilder123!"));'
          $hash = dotnet run --project $tmpDir --no-launch-profile
          Write-Host "Hash generated: $($hash.Substring(0,20))..."
          Remove-Item $tmpDir -Recurse -Force
          
          # Update in DB
          $sql = "USE [SOP_Builder]; UPDATE [dbo].[Users] SET PasswordHash = '$hash' WHERE Email = 'admin@sopbuilder.com'; SELECT Email, Name, Role FROM Users;"
          $result = Invoke-Sqlcmd -Query $sql -ServerInstance "localhost"
          Write-Host "Admin updated:"
          $result | Format-Table

      - name: Create appsettings.Production.json
        shell: powershell
        run: |
          $apiPath = "F:\New_WWW\sop.synthia.bot\API"
          $prodConfig = Join-Path $apiPath "appsettings.Production.json"
          
          if (!(Test-Path $prodConfig)) {
            $bytes = New-Object byte[] 32
            [System.Security.Cryptography.RandomNumberGenerator]::Fill($bytes)
            $jwtKey = [Convert]::ToBase64String($bytes)
            
            $json = @"
          {
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost;Database=SOP_Builder;Trusted_Connection=true;TrustServerCertificate=true;"
            },
            "Jwt": {
              "Key": "$jwtKey",
              "Issuer": "SopBuilder",
              "Audience": "SopBuilderUsers"
            },
            "Storage": {
              "LocalPath": "F:\\uploads",
              "Type": "local"
            }
          }
          "@
            $json | Out-File -FilePath $prodConfig -Encoding UTF8
            Write-Host "Created appsettings.Production.json"
          } else {
            Write-Host "Already exists - skipping"
          }

      - name: Restart App Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          $pool = "sop.synthia.bot"
          try {
            Restart-WebAppPool -Name $pool
            Write-Host "App pool '$pool' restarted"
          } catch {
            Write-Host "Warning: $_"
          }

      - name: Verify
        shell: powershell
        run: |
          $tables = Invoke-Sqlcmd -Query "USE [SOP_Builder]; SELECT name FROM sys.tables ORDER BY name;" -ServerInstance "localhost"
          Write-Host "Tables:" 
          $tables | Format-Table
          
          $users = Invoke-Sqlcmd -Query "USE [SOP_Builder]; SELECT Id, Email, Name, Role FROM Users;" -ServerInstance "localhost"
          Write-Host "Users:"
          $users | Format-Table
