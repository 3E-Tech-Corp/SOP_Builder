name: Setup Database

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Run SQL Schema
        shell: powershell
        run: |
          Write-Host "Running 001-initial-schema.sql on SQL Server..."
          Invoke-Sqlcmd -InputFile "backend\SopBuilder.Api\Database\001-initial-schema.sql" -ServerInstance "localhost" -Verbose
          Write-Host "Schema created successfully!"

      - name: Update Admin Password Hash
        shell: powershell
        run: |
          # Pre-computed BCrypt hash for "SopBuilder123!"
          $hash = '$2a$11$b0UYn/F7om7WBN9l6XtsZuxn8TfHUiV9duKqw7s709hgvKE5lQAR2'
          
          $sql = "USE [SOP_Builder]; UPDATE [dbo].[Users] SET PasswordHash = '$hash' WHERE Email = 'admin@sopbuilder.com';"
          Invoke-Sqlcmd -Query $sql -ServerInstance "localhost" 
          Write-Host "Admin password hash updated!"

      - name: Create appsettings.Production.json
        shell: powershell
        run: |
          $apiPath = "F:\New_WWW\sop.synthia.bot\API"
          $prodConfig = Join-Path $apiPath "appsettings.Production.json"
          
          if (!(Test-Path $prodConfig)) {
            # Generate a random JWT key
            $bytes = New-Object byte[] 32
            [System.Security.Cryptography.RandomNumberGenerator]::Fill($bytes)
            $jwtKey = [Convert]::ToBase64String($bytes)
            
            $config = @{
              ConnectionStrings = @{
                DefaultConnection = "Server=localhost;Database=SOP_Builder;Trusted_Connection=true;TrustServerCertificate=true;"
              }
              Jwt = @{
                Key = $jwtKey
                Issuer = "SopBuilder"
                Audience = "SopBuilderUsers"
              }
              Storage = @{
                LocalPath = "F:\uploads"
                Type = "local"
              }
            } | ConvertTo-Json -Depth 3
            
            $config | Out-File -FilePath $prodConfig -Encoding UTF8
            Write-Host "Created appsettings.Production.json with generated JWT key"
          } else {
            Write-Host "appsettings.Production.json already exists - skipping"
          }

      - name: Verify
        shell: powershell
        run: |
          $result = Invoke-Sqlcmd -Query "USE [SOP_Builder]; SELECT COUNT(*) as TableCount FROM sys.tables;" -ServerInstance "localhost" 
          Write-Host "Tables in SOP_Builder: $($result.TableCount)"
          
          $users = Invoke-Sqlcmd -Query "USE [SOP_Builder]; SELECT Email, Role FROM Users;" -ServerInstance "localhost" 
          Write-Host "Users:"
          $users | Format-Table
